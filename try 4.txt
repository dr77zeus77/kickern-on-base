htmlDownloadCopy code<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kickn - Base Chain Football</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        :root {
            --primary: #0052FF; /* Base Chain Blue */
            --accent: #00F0FF;
            --dark: #0a0b0e;
            --surface: #16181d;
            --surface-light: #1f2229;
            --success: #00ff9d;
            --danger: #ff4d4d;
            --warning: #f1c40f;
            --usdc: #2775CA;
            --text: #ffffff;
            --font-main: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--dark);
            color: var(--text);
            font-family: var(--font-main);
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #app {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: rgba(22, 24, 29, 0.95);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            z-index: 20;
        }

        .logo { font-weight: 800; font-size: 1.2rem; color: var(--text); letter-spacing: -0.5px; }
        .logo span { color: var(--primary); }

        .header-controls { display: flex; gap: 10px; align-items: center; }

        .btn-connect {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .btn-connected { border-color: var(--primary); background: rgba(0, 82, 255, 0.2); }

        .currency-display {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(0, 82, 255, 0.15);
            padding: 4px 10px;
            border-radius: 15px;
            border: 1px solid rgba(0, 82, 255, 0.4);
            font-weight: bold;
            font-size: 0.85rem;
        }
        .currency-icon { width: 12px; height: 12px; background: var(--accent); border-radius: 50%; }

        /* Screens */
        .screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center;
            background: var(--dark);
            transition: opacity 0.3s ease;
            opacity: 0; pointer-events: none; z-index: 1;
            padding: 20px;
            padding-top: 70px; /* Space for header */
            overflow-y: auto;
        }
        .screen.active { opacity: 1; pointer-events: all; z-index: 5; }

        /* Generic UI Components */
        h1, h2 { margin: 0 0 15px 0; text-align: center; }
        p { color: #888; text-align: center; max-width: 400px; line-height: 1.5; }
        
        .btn {
            background: var(--primary); color: white; border: none;
            padding: 12px 30px; font-size: 1rem; border-radius: 50px;
            cursor: pointer; font-weight: bold; margin: 8px;
            transition: transform 0.1s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(0, 82, 255, 0.3);
            min-width: 160px;
        }
        .btn:hover { transform: translateY(-2px); }
        .btn:active { transform: translateY(1px); }
        .btn-secondary { background: var(--surface); border: 1px solid rgba(255,255,255,0.2); box-shadow: none; }
        .btn-store { background: linear-gradient(45deg, #FFD700, #FFA500); color: #000; }
        .btn-usdc { background: var(--usdc); box-shadow: 0 4px 15px rgba(39, 117, 202, 0.4); }
        .btn-small { padding: 8px 16px; min-width: auto; font-size: 0.9rem; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        /* Grid Layouts */
        .grid-menu { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; max-width: 400px; margin-top: 20px; }
        .menu-card {
            background: var(--surface); padding: 20px; border-radius: 15px;
            display: flex; flex-direction: column; align-items: center;
            border: 1px solid rgba(255,255,255,0.05); cursor: pointer;
            transition: 0.2s;
        }
        .menu-card:hover { background: var(--surface-light); transform: translateY(-3px); border-color: var(--primary); }
        .menu-icon { font-size: 2rem; margin-bottom: 10px; }

        /* Setup Screen */
        .team-grid { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; justify-content: center; }
        .team-card {
            width: 60px; height: 80px; background: var(--surface); border: 2px solid transparent;
            border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer;
        }
        .team-card.selected { border-color: var(--primary); background: rgba(0, 82, 255, 0.1); }
        .team-color { width: 25px; height: 25px; border-radius: 50%; margin-bottom: 8px; border: 2px solid rgba(255,255,255,0.2); }
        
        .mode-container { display: flex; gap: 15px; margin-bottom: 20px; }
        .mode-card {
            background: var(--surface); padding: 15px; border-radius: 12px; cursor: pointer;
            border: 2px solid transparent; text-align: center; width: 100px;
        }
        .mode-card.selected { border-color: var(--primary); }
        .mode-icon { font-size: 1.5rem; display: block; margin-bottom: 5px; }

        /* Rewards Screen */
        .reward-card {
            background: var(--surface); width: 100%; max-width: 400px;
            border-radius: 15px; padding: 20px; margin-bottom: 15px;
            border: 1px solid rgba(255,255,255,0.1);
            display: flex; justify-content: space-between; align-items: center;
        }
        .reward-info h3 { margin: 0 0 5px 0; font-size: 1.1rem; }
        .reward-info span { color: var(--accent); font-size: 0.9rem; }
        .timer { font-family: monospace; color: #888; font-size: 0.9rem; margin-top: 5px; }

        /* Leaderboard Screen */
        .leaderboard-list { width: 100%; max-width: 400px; background: var(--surface); border-radius: 15px; overflow: hidden; }
        .lb-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 20px; border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .lb-row:last-child { border-bottom: none; }
        .lb-rank { font-weight: bold; width: 30px; color: #888; }
        .lb-rank.top-1 { color: #FFD700; }
        .lb-rank.top-2 { color: #C0C0C0; }
        .lb-rank.top-3 { color: #CD7F32; }
        .lb-name { flex: 1; font-weight: 500; }
        .lb-score { font-weight: bold; color: var(--primary); }

        /* NFT Screen */
        .nft-preview {
            width: 200px; height: 200px; background: linear-gradient(135deg, #222, #333);
            border-radius: 20px; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center;
            border: 2px solid var(--primary); position: relative; overflow: hidden;
            box-shadow: 0 0 30px rgba(0, 82, 255, 0.2);
        }
        .nft-text {
            font-weight: 900; font-size: 2rem; text-transform: uppercase;
            background: linear-gradient(45deg, #fff, var(--primary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            transform: rotate(-15deg);
        }
        .supply-bar { width: 100%; max-width: 300px; height: 6px; background: #333; border-radius: 3px; margin: 10px 0 20px; overflow: hidden; }
        .supply-fill { height: 100%; background: var(--success); width: 0%; transition: width 0.5s; }

        /* Store Screen */
        .store-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; width: 100%; max-width: 600px; }
        .store-item {
            background: var(--surface); border-radius: 12px; padding: 15px;
            display: flex; flex-direction: column; align-items: center;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .store-item-icon { font-size: 2rem; margin-bottom: 10px; }
        .store-item-price { color: var(--accent); font-weight: bold; margin-bottom: 10px; }
        .store-btn { background: rgba(255,255,255,0.1); border: none; color: white; padding: 5px 15px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }

        /* Game Screen */
        #screen-game { padding: 0; background: #222; overflow: hidden; }
        #game-container { position: relative; width: 100%; height: 100%; background: #1a2c1a; overflow: hidden; }
        canvas { display: block; width: 100%; height: 100%; }
        .game-ui {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; padding: 20px;
        }
        .score-board {
            font-size: 2rem; font-weight: bold; text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            align-self: center; background: rgba(0,0,0,0.5); padding: 5px 20px; border-radius: 20px;
        }
        .difficulty-badge {
            position: absolute; top: 80px; right: 20px;
            background: rgba(241, 196, 15, 0.2); border: 1px solid var(--warning);
            color: var(--warning); padding: 5px 10px; border-radius: 10px; font-weight: bold;
            font-size: 0.8rem; opacity: 0; transition: opacity 0.3s;
        }

        /* Toast */
        .toast {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: var(--surface); border: 1px solid var(--primary); padding: 12px 24px;
            border-radius: 30px; display: flex; flex-direction: column; align-items: center; gap: 5px;
            opacity: 0; transition: opacity 0.3s; pointer-events: none; z-index: 100;
            width: max-content; max-width: 90%;
            text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .toast.show { opacity: 1; }
        .tx-hash { font-size: 0.65rem; color: #888; display: block; word-break: break-all; margin-top: 2px; }

        .chain-dot { width: 8px; height: 8px; background: var(--success); border-radius: 50%; box-shadow: 0 0 10px var(--success); display: inline-block; margin-right: 5px; }
    </style>
</head>
<body>

<div id="app">
    <!-- Header -->
    <header>
        <div class="logo">Kick<span>n</span></div>
        <div class="header-controls">
            <button id="btn-wallet" class="btn-connect" onclick="connectWallet()">
                <span class="chain-dot"></span> Connect Wallet
            </button>
            <div class="currency-display">
                <span class="currency-icon"></span>
                <span id="balance">0</span> KICK
            </div>
        </div>
    </header>

    <!-- MAIN MENU -->
    <div id="screen-menu" class="screen active">
        <h1 style="font-size: 2.5rem; margin-bottom: 5px;">Kickn</h1>
        <p style="margin-bottom: 30px;">Web3 Football on Base Chain</p>
        
        <div class="grid-menu">
            <div class="menu-card" onclick="navigateTo('screen-setup')">
                <span class="menu-icon">‚öΩ</span>
                <div>Play</div>
            </div>
            <div class="menu-card" onclick="navigateTo('screen-store')">
                <span class="menu-icon">üí∞</span>
                <div>Store</div>
            </div>
            <div class="menu-card" onclick="navigateTo('screen-rewards')">
                <span class="menu-icon">üéÅ</span>
                <div>Rewards</div>
            </div>
            <div class="menu-card" onclick="navigateTo('screen-nft')">
                <span class="menu-icon">üñºÔ∏è</span>
                <div>Collection</div>
            </div>
            <div class="menu-card" onclick="navigateTo('screen-leaderboard')" style="grid-column: span 2;">
                <span class="menu-icon">üèÜ</span>
                <div>Leaderboard</div>
            </div>
        </div>
    </div>

    <!-- SETUP SCREEN -->
    <div id="screen-setup" class="screen">
        <h2>Select Team</h2>
        <div class="team-grid" id="team-grid"></div>

        <h2>Mode</h2>
        <div class="mode-container">
            <div class="mode-card selected" data-mode="penalty" onclick="selectMode('penalty')">
                <span class="mode-icon">‚öΩ</span>
                <div>Penalty</div>
            </div>
            <div class="mode-card" data-mode="freekick" onclick="selectMode('freekick')">
                <span class="mode-icon">üß±</span>
                <div>Free Kick</div>
            </div>
        </div>

        <button class="btn" onclick="startGame()">Start Match</button>
        <button class="btn btn-secondary btn-small" onclick="navigateTo('screen-menu')">Back</button>
    </div>

    <!-- GAME SCREEN -->
    <div id="screen-game" class="screen">
        <div id="game-container">
            <canvas id="gameCanvas"></canvas>
            <div class="game-ui">
                <div class="score-board">
                    <span id="score-goals">0</span> - <span id="score-misses">0</span>
                </div>
                <div class="difficulty-badge" id="difficulty-badge">Level 1</div>
                <div style="text-align: center; color: rgba(255,255,255,0.7); font-size: 0.9rem; margin-bottom: 20px;" id="instruction-text">
                    Tap to shoot
                </div>
            </div>
        </div>
        <button class="btn btn-secondary btn-small" style="position: absolute; top: 70px; left: 20px; z-index: 20;" onclick="endGame()">Exit</button>
    </div>

    <!-- STORE SCREEN -->
    <div id="screen-store" class="screen">
        <h2>Token Shop</h2>
        <div class="store-grid" id="store-grid"></div>
        <button class="btn btn-secondary btn-small" onclick="navigateTo('screen-menu')">Back</button>
    </div>

    <!-- REWARDS SCREEN -->
    <div id="screen-rewards" class="screen">
        <h2>Check-In Rewards</h2>
        
        <div class="reward-card">
            <div class="reward-info">
                <h3>Daily Bonus</h3>
                <span>10 Free KICK</span>
                <div class="timer" id="timer-daily">Available Now</div>
            </div>
            <button class="btn btn-small" id="btn-daily" onclick="claimDaily()">Claim</button>
        </div>

        <div class="reward-card">
            <div class="reward-info">
                <h3>12H Base Reward</h3>
                <span>10 KICK (+Tx Fee)</span>
                <div class="timer" id="timer-12h">Available Now</div>
            </div>
            <button class="btn btn-small" id="btn-12h" onclick="claim12h()">Claim</button>
        </div>

        <p style="font-size: 0.8rem; margin-top: 20px;">
            12H Check-in requires a transaction. Fees are routed to treasury wallet.
        </p>
        <button class="btn btn-secondary btn-small" onclick="navigateTo('screen-menu')">Back</button>
    </div>

    <!-- LEADERBOARD SCREEN -->
    <div id="screen-leaderboard" class="screen">
        <h2>Top Scorers</h2>
        <div class="leaderboard-list" id="lb-list"></div>
        <button class="btn btn-secondary btn-small" style="margin-top: 20px;" onclick="navigateTo('screen-menu')">Back</button>
    </div>

    <!-- NFT SCREEN -->
    <div id="screen-nft" class="screen">
        <h2>Stay Kickn NFT</h2>
        <div class="nft-preview">
            <div class="nft-text">Stay<br>Kickn</div>
        </div>
        
        <div style="text-align: center;">
            <h3>Limited Supply: 1200</h3>
            <p style="color: var(--usdc); font-weight: bold;">Price: 5 USDC</p>
        </div>

        <div class="supply-bar">
            <div class="supply-fill" id="nft-fill"></div>
        </div>
        <div style="text-align: center; margin-bottom: 20px;">
            <span id="nft-count">842</span> / 1200 Minted
        </div>

        <button class="btn btn-usdc" id="btn-mint" onclick="mintNFT()">Mint for 5 USDC</button>
        <p style="font-size: 0.7rem; margin-top: 10px;">Funds sent to Treasury: 0xf6b...9dF</p>
        <button class="btn btn-secondary btn-small" onclick="navigateTo('screen-menu')">Back</button>
    </div>

    <!-- TOAST -->
    <div id="toast" class="toast">
        <div style="display:flex; gap:10px; align-items:center;">
            <span id="toast-icon" style="font-size: 1.5rem;">‚ÑπÔ∏è</span>
            <span id="toast-msg" style="font-weight:bold;">Notification</span>
        </div>
        <span id="toast-tx" class="tx-hash"></span>
    </div>

</div>

<script>
    /* --- State & Data --- */
    const TREASURY_WALLET = "0xf6b6a99ca3dec56044C316fbb63E9d144a0cB9dF";
    
    const state = {
        balance: 0,
        walletAddress: null,
        team: null,
        mode: 'penalty',
        score: { goals: 0, misses: 0 },
        gameActive: false,
        difficulty: 1,
        totalShots: 0,
        nftMinted: 842,
        maxNft: 1200,
        dailyLastClaim: 0,
        h12LastClaim: 0,
        leaderboard: [
            { name: "BaseKing", score: 150 },
            { name: "CryptoStriker", score: 142 },
            { name: "KicknGod", score: 135 },
            { name: "L2Ronaldo", score: 120 },
            { name: "GasWarrior", score: 98 }
        ]
    };

    const teams = [
        { id: 1, name: 'Neon City', color: '#00F0FF' },
        { id: 2, name: 'Crimson', color: '#FF4D4D' },
        { id: 3, name: 'Golden', color: '#FFD700' },
        { id: 4, name: 'Shadow', color: '#800080' },
        { id: 5, name: 'Eco', color: '#00FF9D' }
    ];

    /* --- Audio --- */
    let synth, kickSynth;
    async function initAudio() {
        if (synth) return;
        await Tone.start();
        synth = new Tone.PolySynth(Tone.Synth).toDestination();
        synth.volume.value = -5;
        kickSynth = new Tone.MembraneSynth({
            pitchDecay: 0.05, octaves: 10, oscillator: { type: "sine" },
            envelope: { attack: 0.001, decay: 0.4, sustain: 0.01, release: 1.4 }
        }).toDestination();
        kickSynth.volume.value = -10;
    }

    function playSound(type) {
        if (!synth) return;
        if (type === 'click') synth.triggerAttackRelease("C6", "32n");
        else if (type === 'kick') kickSynth.triggerAttackRelease("C2", "32n");
        else if (type === 'success') {
            const now = Tone.now();
            const player = new Tone.PolySynth(Tone.Synth).toDestination();
            player.triggerAttackRelease(["C5","E5","G5"], "8n", now);
        } else if (type === 'levelup') {
             const now = Tone.now();
            const player = new Tone.PolySynth(Tone.Synth).toDestination();
            player.triggerAttackRelease(["C4","E4","G4","C5"], "16n", now);
        }
    }

    /* --- Navigation --- */
    function navigateTo(screenId) {
        playSound('click');
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(screenId).classList.add('active');
        
        const gameContainer = document.getElementById('game-container');
        if (screenId === 'screen-game') {
            gameContainer.style.display = 'block';
            if (!state.gameActive) initGame();
        } else {
            gameContainer.style.display = 'none';
            state.gameActive = false;
        }
    }

    function updateBalanceDisplay() {
        document.getElementById('balance').innerText = state.balance;
    }

    function showToast(msg, icon='‚ÑπÔ∏è', txHash=null) {
        const toast = document.getElementById('toast');
        document.getElementById('toast-msg').innerText = msg;
        document.getElementById('toast-icon').innerText = icon;
        const txEl = document.getElementById('toast-tx');
        txEl.innerText = txHash ? `${txHash}` : '';
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 5000);
    }

    /* --- Wallet Logic --- */
    async function connectWallet() {
        if (typeof window.ethereum !== 'undefined') {
            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                state.walletAddress = accounts[0];
                const shortAddr = `${state.walletAddress.substring(0,6)}...${state.walletAddress.substring(38)}`;
                document.getElementById('btn-wallet').innerHTML = `<span class="chain-dot"></span> ${shortAddr}`;
                document.getElementById('btn-wallet').classList.add('btn-connected');
                showToast("Wallet Connected to Base", "‚úÖ");
                playSound('success');
            } catch (error) { simulateConnect(); }
        } else { simulateConnect(); }
    }

    function simulateConnect() {
        const fakeAddr = "0x71C...9A23";
        state.walletAddress = fakeAddr;
        document.getElementById('btn-wallet').innerHTML = `<span class="chain-dot"></span> ${fakeAddr}`;
        document.getElementById('btn-wallet').classList.add('btn-connected');
        showToast("Wallet Connected (Simulated)", "‚úÖ");
        playSound('success');
    }

    /* --- Rewards Logic --- */
    function claimDaily() {
        const now = Date.now();
        const btn = document.getElementById('btn-daily');
        if (now - state.dailyLastClaim < 86400000) {
            showToast("Already claimed today", "‚è≥");
            return;
        }
        playSound('click');
        state.dailyLastClaim = now;
        state.balance += 10;
        updateBalanceDisplay();
        showToast("Claimed 10 Free KICK!", "üéÅ");
        btn.disabled = true;
        btn.innerText = "Claimed";
    }

    function claim12h() {
        const now = Date.now();
        const btn = document.getElementById('btn-12h');
        if (now - state.h12LastClaim < 43200000) {
            showToast("Cooldown active", "‚è≥");
            return;
        }
        playSound('click');
        showToast("Confirming Transaction...", "‚è≥");
        
        setTimeout(() => {
            state.h12LastClaim = now;
            state.balance += 10;
            updateBalanceDisplay();
            const hash = "Tx: 0x" + Array(40).fill(0).map(() => Math.floor(Math.random() * 16).toString(16)).join('');
            showToast("Fees sent to Treasury", "‚úÖ", `Fees -> ${TREASURY_WALLET.substring(0,6)}...${TREASURY_WALLET.substring(38)}`);
            playSound('success');
            btn.disabled = true;
            btn.innerText = "Claimed";
        }, 2000);
    }

    /* --- NFT Logic --- */
    function updateNftUI() {
        document.getElementById('nft-count').innerText = state.nftMinted;
        const pct = (state.nftMinted / state.maxNft) * 100;
        document.getElementById('nft-fill').style.width = `${pct}%`;
        const btn = document.getElementById('btn-mint');
        if (state.nftMinted >= state.maxNft) {
            btn.disabled = true;
            btn.innerText = "Sold Out";
        }
    }

    function mintNFT() {
        if (state.nftMinted >= state.maxNft) return;
        if (!state.walletAddress) {
            showToast("Please Connect Wallet First", "‚ö†Ô∏è");
            connectWallet();
            return;
        }
        
        playSound('click');
        const btn = document.getElementById('btn-mint');
        const originalText = btn.innerText;
        btn.innerText = "Confirming in Wallet...";
        btn.disabled = true;

        showToast("Sending 5 USDC...", "üí∏", `To: ${TREASURY_WALLET.substring(0,10)}...`);

        setTimeout(() => {
            state.nftMinted++;
            updateNftUI();
            const hash = "Tx: 0x" + Array(40).fill(0).map(() => Math.floor(Math.random() * 16).toString(16)).join('');
            showToast("Mint Successful!", "üñºÔ∏è", hash);
            playSound('success');
            btn.innerText = originalText;
            btn.disabled = false;
        }, 2500);
    }

    /* --- Game Setup --- */
    function renderTeams() {
        const grid = document.getElementById('team-grid');
        grid.innerHTML = teams.map(team => `
            <div class="team-card ${state.team && state.team.id === team.id ? 'selected' : ''}" 
                 onclick="selectTeam(${team.id})">
                <div class="team-color" style="background:${team.color}"></div>
                <div style="font-size:0.7rem; font-weight:bold;">${team.name}</div>
            </div>
        `).join('');
    }

    function selectTeam(id) {
        state.team = teams.find(t => t.id === id);
        renderTeams();
        playSound('click');
    }

    function selectMode(mode) {
        state.mode = mode;
        document.querySelectorAll('.mode-card').forEach(c => c.classList.toggle('selected', c.dataset.mode === mode));
        playSound('click');
    }

    function startGame() {
        if (!state.team) { showToast("Select a team first!", "‚ö†Ô∏è"); return; }
        state.difficulty = 1;
        state.totalShots = 0;
        document.getElementById('difficulty-badge').innerText = "Level 1";
        document.getElementById('difficulty-badge').style.opacity = 0;
        navigateTo('screen-game');
    }

    /* --- Game Engine --- */
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    let animationId;
    let ball, goalPost, keeper, wall;
    let dragStart = null;

    function resizeCanvas() {
        canvas.width = canvas.parentElement.clientWidth;
        canvas.height = canvas.parentElement.clientHeight;
        resetBall();
    }

    function resetBall() {
        ball = { x: canvas.width/2, y: canvas.height - 80, z: 0, vx: 0, vy: 0, vz: 0, r: 8, active: false, scored: false };
        keeper = { x: canvas.width/2, y: 100, w: 40, h: 60, vx: 0, speed: 0.04 + (state.difficulty * 0.01) };
        goalPost = { x: (canvas.width - 300)/2, y: 50, w: 300, h: 80 };
        wall = [];
        if (state.mode === 'freekick') {
            for(let i=0; i<4; i++) wall.push({ x: (canvas.width/2 - 70) + (i*45), y: 230, w: 30, h: 70, dir: 1 });
        }
        document.getElementById('instruction-text').innerText = state.mode === 'penalty' ? "Tap to Shoot" : "Drag & Release";
    }

    function initGame() {
        initAudio();
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        
        canvas.onmousedown = handleStart;
        canvas.ontouchstart = (e) => { e.preventDefault(); handleStart(e.touches[0]); };
        
        state.gameActive = true;
        resetBall();
        loop();
    }

    function increaseDifficulty() {
        state.difficulty++;
        const badge = document.getElementById('difficulty-badge');
        badge.innerText = `Level ${state.difficulty}`;
        badge.style.opacity = 1;
        playSound('levelup');
        showToast("Difficulty Increased!", "üî•");
    }

    function handleStart(e) {
        if (!state.gameActive || ball.active) return;
        const rect = canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        if (state.mode === 'penalty') {
            shootPenalty();
        } else {
            dragStart = { x, y };
            canvas.onmousemove = handleMove;
            canvas.onmouseup = handleEnd;
            canvas.ontouchmove = (e) => { e.preventDefault(); handleMove(e.touches[0]); };
            canvas.ontouchend = handleEnd;
        }
    }

    function handleMove(e) { if (dragStart) {/* visual feedback */} }

    function handleEnd(e) {
        if (!dragStart) return;
        const rect = canvas.getBoundingClientRect();
        const endX = e.clientX - rect.left;
        const endY = e.clientY - rect.top;
        
        const dx = dragStart.x - endX;
        const dy = dragStart.y - endY;
        const power = Math.min(Math.sqrt(dx*dx + dy*dy), 200);
        
        ball.active = true;
        ball.vx = dx * 0.1;
        ball.vy = dy * 0.1;
        ball.vz = 5 + power * 0.05;
        
        state.totalShots++;
        if (state.totalShots % 10 === 0) increaseDifficulty();

        playSound('kick');
        dragStart = null;
        canvas.onmousemove = null;
        canvas.onmouseup = null;
        canvas.ontouchmove = null;
        canvas.ontouchend = null;
    }

    function shootPenalty() {
        ball.active = true;
        ball.vy = -12 - Math.random() * 4;
        ball.vx = (Math.random() - 0.5) * 8;
        ball.vz = 6;
        
        state.totalShots++;
        if (state.totalShots % 10 === 0) increaseDifficulty();
        
        playSound('kick');
    }

    function update() {
        if (ball.active) {
            ball.x += ball.vx;
            ball.y += ball.vy;
            ball.z += ball.vz;
            ball.vz -= 0.25;

            if (ball.z < 0) {
                ball.z = 0;
                ball.vz = -ball.vz * 0.5;
                ball.vx *= 0.7;
                ball.vy *= 0.7;
                if (Math.abs(ball.vz) < 1) ball.active = false;
            }

            // Goal
            if (ball.y < goalPost.y + 20 && ball.y > goalPost.y - 10) {
                if (ball.x > goalPost.x && ball.x < goalPost.x + goalPost.w) {
                    if (ball.z < goalPost.h && !ball.scored) {
                        ball.scored = true;
                        handleGoal();
                    }
                } else if (ball.y < 0) ball.active = false;
            }

            // Keeper Tracking
            const targetX = ball.x;
            // Keeper gets smarter/faster with difficulty
            const reactionError = Math.max(0, 50 - (state.difficulty * 5)); // Reduces error margin
            keeper.x += (targetX - keeper.x) * keeper.speed;
            
            // Keeper Save
            if (ball.active && ball.z < keeper.h && ball.y < keeper.y + keeper.h && ball.y > keeper.y && Math.abs(ball.x - keeper.x) < 30) {
                ball.active = false;
                handleMiss("Saved!");
            }

            // Wall Collision & Movement
            wall.forEach((w, i) => {
                // Wall moves at higher difficulty
                if (state.difficulty >= 3 && state.mode === 'freekick') {
                    w.x += Math.sin(Date.now() / 500 + i) * (state.difficulty * 0.5);
                }

                if (ball.active && ball.x > w.x && ball.x < w.x+w.w && ball.y < w.y+w.h && ball.y > w.y && ball.z < w.h) {
                    ball.vx = -ball.vx * 0.8;
                    ball.vy = -ball.vy * 0.8;
                    playSound('click');
                }
            });

            if (ball.y < -50 || ball.x < -50 || ball.x > canvas.width + 50) ball.active = false;
        }
    }

    function handleGoal() {
        state.score.goals++;
        state.balance += 5;
        updateBalanceDisplay();
        document.getElementById('score-goals').innerText = state.score.goals;
        showToast("GOAL! +5 KICK", "‚öΩ");
        playSound('success');
        setTimeout(resetBall, 1500);
    }

    function handleMiss(reason) {
        state.score.misses++;
        document.getElementById('score-misses').innerText = state.score.misses;
        showToast(reason, "‚ùå");
        playSound('click');
        setTimeout(resetBall, 1500);
    }

    function draw() {
        ctx.fillStyle = '#1a2c1a';
        ctx.fillRect(0,0,canvas.width, canvas.height);
        
        ctx.strokeStyle = 'rgba(255,255,255,0.2)';
        ctx.lineWidth = 3;
        ctx.strokeRect((canvas.width-400)/2, 50, 400, 200);
        
        ctx.fillStyle = 'rgba(255,255,255,0.1)';
        ctx.fillRect(goalPost.x, goalPost.y, goalPost.w, goalPost.h);

        if (state.mode === 'freekick') {
            ctx.fillStyle = '#e74c3c';
            wall.forEach(w => ctx.fillRect(w.x, w.y, w.w, w.h));
        }

        ctx.fillStyle = '#f39c12';
        ctx.fillRect(keeper.x-20, keeper.y, 40, keeper.h);

        ctx.fillStyle = '#fff';
        const scale = 1 + ball.z/100;
        ctx.beginPath();
        ctx.arc(ball.x, ball.y - ball.z, ball.r * scale, 0, Math.PI*2);
        ctx.fill();
    }

    function loop() {
        if (!state.gameActive) return;
        update();
        draw();
        animationId = requestAnimationFrame(loop);
    }

    function endGame() {
        state.gameActive = false;
        cancelAnimationFrame(animationId);
        renderLeaderboard();
        navigateTo('screen-menu');
    }

    /* --- Init --- */
    function renderLeaderboard() {
        const list = document.getElementById('lb-list');
        const currentUser = { name: "You", score: state.score.goals, isUser: true };
        const allPlayers = [...state.leaderboard, currentUser].sort((a,b) => b.score - a.score);
        list.innerHTML = allPlayers.map((p, i) => `
            <div class="lb-row" style="${p.isUser ? 'border: 1px solid var(--primary);' : ''}">
                <div class="lb-rank ${i < 3 ? 'top-'+(i+1) : ''}">#${i + 1}</div>
                <div class="lb-name">${p.name}</div>
                <div class="lb-score">${p.score}</div>
            </div>
        `).join('');
    }

    function renderStore() {
        const grid = document.getElementById('store-grid');
        const items = [
            { name: "Starter Pack", price: "Free", amount: 100, icon: "üí∞" },
            { name: "100 KICK", price: "$0.50", amount: 100, icon: "üíé" },
            { name: "500 KICK", price: "$2.00", amount: 500, icon: "üöÄ" }
        ];
        grid.innerHTML = items.map(item => `
            <div class="store-item">
                <div class="store-item-icon">${item.icon}</div>
                <div style="font-weight:bold; font-size:0.9rem;">${item.name}</div>
                <div class="store-item-price">${item.price}</div>
                <button class="store-btn" onclick="buyItem(${item.amount}, '${item.name}')">Buy</button>
            </div>
        `).join('');
    }
    
    function buyItem(amount, name) {
        playSound('click');
        showToast("Processing on Base...", "üí≥");
        setTimeout(() => { state.balance += amount; updateBalanceDisplay(); showToast(`Purchased ${name}`, "‚úÖ"); }, 1500);
    }

    renderTeams(); renderStore(); updateNftUI(); renderLeaderboard();
</script>
</body>
</html>